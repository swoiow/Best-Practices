# .github/workflows/build-release.yml
name: Build & Package {{PROJECT_NAME}}

on:
  push:
    branches: [ "main" ]
    tags:     [ "v*.*.*" ]           # æ‰“ tag è‡ªåŠ¨å‘å¸ƒï¼ˆå¯é€‰ï¼Œè§ release jobï¼‰
  workflow_dispatch:

concurrency:
  group: build-release
  cancel-in-progress: true

env:
  # ===== å¯é…åŒºåŸŸï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰=====
  PROJECT_NAME: "{{PROJECT_NAME}}"   # ä¾‹ï¼šPyTrade / NetPilot
  WHEEL_RETENTION_DAYS: "7"          # artifact ä¿ç•™å¤©æ•°
  PACKAGE_ZIP_NAME: "{{artifact_name}}-all.zip"
  EXTRA_PIP: "cython requests"       # é¢å¤–ä¾èµ–ï¼ˆæŒ‰éœ€ï¼‰
  # PyInstaller å¼€å…³ï¼ˆéœ€è¦æ—¶è®¾ä¸º "1"ï¼‰
  ENABLE_PYINSTALLER: "0"
  PYINSTALLER_ENTRY: "entrypoints.py"
  PYINSTALLER_NAME: "{{bin_name}}"
  # ==============================

jobs:
  build-wheels:
    name: Build on ${{ matrix.os }} / Python ${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # éœ€è¦ macOS å°±åŠ ä¸Š "macos-latest"
        os: [ ubuntu-latest, windows-latest ]
        python: [ "3.10", "3.11", "3.12", "3.13" ]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: "pip"

      - name: ğŸ“¦ Create venv & expose PYTHON_EXEC
        shell: bash
        run: |
          python -m venv venv
          if [ -x "venv/bin/python" ]; then
            echo "PYTHON_EXEC=$(pwd)/venv/bin/python" >> $GITHUB_ENV
          else
            echo "PYTHON_EXEC=$(pwd)/venv/Scripts/python.exe" >> $GITHUB_ENV
          fi

      # ï¼ˆå¯é€‰ï¼‰å¤–éƒ¨æ¨¡å—åˆå¹¶/é¢„å¤„ç†è„šæœ¬
      # - name: ğŸ”— Merge external modules
      #   run: $PYTHON_EXEC .github/add_external_module.py --repo <your-repo>
      #   shell: bash

      - name: ğŸ“š Install build deps
        shell: bash
        run: |
          $PYTHON_EXEC -m pip install --upgrade pip
          $PYTHON_EXEC -m pip install wheel setuptools ${{ env.EXTRA_PIP }}

      - name: ğŸ—ï¸ Build wheel
        shell: bash
        run: |
          $PYTHON_EXEC setup.py build_ext --inplace
          # å¦‚éœ€è‡ªå®šä¹‰æ ‡å¿—ï¼Œå¯åœ¨ setup.py è§£æ --release
          $PYTHON_EXEC setup.py bdist_wheel --release

      - name: â¬†ï¸ Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.python }}
          path: dist/*.whl
          retention-days: ${{ env.WHEEL_RETENTION_DAYS }}

      # ===== å¯é€‰ï¼šPyInstaller å•æ–‡ä»¶äº§ç‰©ï¼ˆé€šå¸¸ä»…æŸä¸€ç‰ˆæœ¬Pythonæ„å»ºï¼‰=====
      - name: ğŸ› ï¸ Install PyInstaller
        if: env.ENABLE_PYINSTALLER == '1' && matrix.python == '3.12'
        shell: bash
        run: $PYTHON_EXEC -m pip install pyinstaller

      - name: ğŸ“¦ Build PyInstaller binary
        if: env.ENABLE_PYINSTALLER == '1' && matrix.python == '3.12'
        shell: bash
        run: |
          $PYTHON_EXEC -m PyInstaller ${{ env.PYINSTALLER_ENTRY }} \
            --name ${{ env.PYINSTALLER_NAME }} \
            --onefile --strip --clean --noconfirm \
            --exclude-module tkinter --exclude-module unittest --exclude-module email --exclude-module test

      - name: â¬†ï¸ Upload PyInstaller binary
        if: env.ENABLE_PYINSTALLER == '1' && matrix.python == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.os }}-py${{ matrix.python }}
          path: dist/${{ env.PYINSTALLER_NAME }}*
          retention-days: ${{ env.WHEEL_RETENTION_DAYS }}
  # ===================================================================

  package-artifacts:
    name: Package all wheels into one zip
    runs-on: ubuntu-latest
    needs: build-wheels
    steps:
      - name: ğŸ“¥ Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: collected
          merge-multiple: true

      - name: ğŸ“¦ Bundle wheels (single-layer zip)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p packaged
          # ä»…æ‰“åŒ… .whlï¼Œé¿å…æ··å…¥å…¶å®ƒæ–‡ä»¶
          zip -j "packaged/${{ env.PACKAGE_ZIP_NAME }}" collected/*.whl

      - name: â¬†ï¸ Upload packaged zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-packaged
          path: packaged/${{ env.PACKAGE_ZIP_NAME }}
          retention-days: ${{ env.WHEEL_RETENTION_DAYS }}

  # ===== å¯é€‰ï¼šæŒ‰ tag ç›´æ¥å‘å¸ƒ Releaseï¼Œä¸Šä¼ æ‰“å¥½çš„å•å±‚ zip =====
  release:
    name: Publish GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: package-artifacts
    steps:
      - name: ğŸ“¥ Download packaged zip
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-packaged
          path: release

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
