name: Build Slim

concurrency:
  # é˜²æ­¢ä¸åŒåˆ†æ”¯/PR äº’ç›¸å–æ¶ˆ
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        python-version: [ "3.9", "3.10", "3.11", "3.12", "3.13" ]

    runs-on: ${{ matrix.os }}

    env:
      PYTHONIOENCODING: "utf-8"
      PYTHONUTF8: "1"

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: ğŸ“¦ Create virtualenv
        shell: bash
        run: |
          python -m venv venv
          if [ -x "venv/bin/python" ]; then
            echo "PYTHON_EXEC=$(pwd)/venv/bin/python" >> $GITHUB_ENV
          else
            echo "PYTHON_EXEC=$(pwd)/venv/Scripts/python.exe" >> $GITHUB_ENV
          fi

      - name: Install build deps
        shell: bash
        run: |
          $PYTHON_EXEC -m pip install -q --upgrade -r requirements.txt

      - name: Build (wheel + sdist)
        shell: bash
        run: |
          $PYTHON_EXEC setup.py build_ext --inplace
          $PYTHON_EXEC setup.py bdist_wheel --release

      # å¯é€‰ï¼šè°ƒè¯•è¾“å‡ºï¼Œç¡®è®¤ dist ä¸‹ç¡®å®æœ‰æ–‡ä»¶
      - name: List dist
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            dir dist
          else
            ls -al dist
          fi

      - name: Upload artifacts (per-matrix)
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            dist/*.whl
            dist/*.tar.gz
          if-no-files-found: warn
          retention-days: 3

  package-artifacts:
    name: Package all builds into one zip
    needs: build
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: ä¸‹è½½æ‰€æœ‰ç›¸å…³çš„æ„å»º artifacts
      - name: ğŸ“¥ Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: collected
          merge-multiple: true  # åˆå¹¶å¤šä¸ª artifacts

      # æ­¥éª¤ 2: æ‰“åŒ…æ‰€æœ‰ä¸‹è½½çš„ artifacts åˆ°ä¸€ä¸ª zip æ–‡ä»¶ä¸­
      - name: ğŸ“¦ Bundle all builds into a single zip
        run: |
          mkdir -p packaged
          zip -r packaged/all-builds.zip collected/*  # å°†æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ªå‹ç¼©åŒ…
        shell: bash

      # æ­¥éª¤ 3: åˆ é™¤ä¸‹è½½çš„åŸå§‹ artifactsï¼ˆæ¨¡æ‹Ÿ delete-mergedï¼‰
      - name: ğŸ§¹ Clean up the original artifacts
        run: |
          rm -rf collected  # åˆ é™¤ä¸‹è½½çš„æ–‡ä»¶å¤¹ï¼Œæ¸…ç†åŸå§‹ artifacts
        shell: bash

      # æ­¥éª¤ 4: ä¸Šä¼ æ‰“åŒ…å¥½çš„å‹ç¼©åŒ…
      - name: â¬†ï¸ Upload the final packaged zip
        uses: actions/upload-artifact@v4
        with:
          name: all-builds-packaged
          path: packaged/all-builds.zip  # åªä¸Šä¼ ä¸€ä¸ªå‹ç¼©åŒ…
          retention-days: 3
